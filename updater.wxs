<?xml version="1.0" encoding="utf-8"?>

<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  <Fragment>

    <ComponentGroup Id="updater">
      <ComponentRef Id='id_updater.exe' />
    </ComponentGroup>

    <DirectoryRef Id="APPLICATIONFOLDER">
      <Component Id='id_updater.exe' Guid='*'>
        <File Id="id_updater.exe" Source="$(env.PREFIX)\IdCard\IdUpdater\bin\id-updater.exe" Checksum="yes" Vital="yes" />
      </Component>
    </DirectoryRef>

    <CustomAction Id="ScheduleUpdater" FileKey="id_updater.exe" Impersonate="no" Execute="deferred"
                      ExeCommand="-weekly"
                      Return="ignore"/>
    <CustomAction Id="UnScheduleUpdater" Directory="APPLICATIONFOLDER" Impersonate="no" Execute="deferred"
                      ExeCommand="id-updater.exe -remove"
                      Return="ignore"/>
    <util:CloseApplication Id="CloseChrome" Description="Google Chrome needs to be closed!"
                      RebootPrompt="no" Target="chrome.exe" PromptToContinue="yes" ElevatedCloseMessage="yes"/>
    <CustomAction Id="ChromeNPAPI" FileKey="id_updater.exe" Impersonate="no" Execute="deferred"
                      ExeCommand="-chrome-npapi"
                      Return="ignore"/>

    <InstallExecuteSequence>
        <Custom Action="ScheduleUpdater" Before="InstallFinalize">(NOT Installed) AND NOT (AUTO_UPDATE = 0)</Custom>
        <Custom Action="UnScheduleUpdater" After="InstallInitialize">REMOVE="ALL"</Custom>
        <Custom Action="WixCloseApplications" After="InstallInitialize">UPGRADINGPRODUCTCODE OR (NOT REMOVE="ALL")</Custom>
        <Custom Action='ChromeNPAPI' Before='InstallFinalize'/>UPGRADINGPRODUCTCODE OR (NOT REMOVE="ALL")</Custom>
    </InstallExecuteSequence>

  </Fragment>
</Wix>
